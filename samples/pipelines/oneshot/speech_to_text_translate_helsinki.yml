# SPDX-FileCopyrightText: © 2025 StreamKit Contributors
#
# SPDX-License-Identifier: MPL-2.0

#
# skit:input_asset_tags=speech

# Speech Translation using Helsinki-NLP OPUS-MT (Apache 2.0 licensed)
#
# This pipeline is an alternative to speech_to_text_translate.yml that uses
# Helsinki-NLP OPUS-MT models instead of NLLB, suitable for commercial use.
#
# Prerequisites:
#   just download-whisper-models
#   just download-helsinki-models
#   just download-piper-spanish

name: Speech Translation (English → Spanish) - Helsinki
description: Translates English speech into Spanish speech using Apache 2.0 licensed Helsinki OPUS-MT
mode: oneshot
steps:
  - kind: streamkit::http_input

  - kind: containers::ogg::demuxer

  - kind: audio::opus::decoder

  - kind: audio::resampler
    params:
      chunk_frames: 960
      output_frame_size: 960
      target_sample_rate: 16000

  - kind: plugin::native::whisper
    params:
      model_path: models/ggml-tiny.en-q5_1.bin
      language: en
      vad_model_path: models/silero_vad.onnx
      vad_threshold: 0.5
      min_silence_duration_ms: 700
      max_segment_duration_secs: 30.0

  - kind: plugin::native::helsinki
    params:
      model_dir: models/opus-mt-en-es
      source_language: en
      target_language: es
      device: cpu
      max_length: 512

  - kind: plugin::native::piper
    params:
      model_dir: models/vits-piper-es_MX-claude-high
      speed: 1.0
      num_threads: 4

  - kind: audio::resampler
    params:
      chunk_frames: 960
      output_frame_size: 960
      target_sample_rate: 48000

  - kind: audio::opus::encoder
    params:
      bitrate: 64000
      frame_size: 960

  - kind: containers::webm::muxer
    params:
      channels: 1
      chunk_size: 65536
      sample_rate: 48000

  - kind: streamkit::http_output
    params:
      content_type: audio/webm; codecs="opus"
