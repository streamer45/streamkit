# SPDX-FileCopyrightText: Â© 2025 StreamKit Contributors
#
# SPDX-License-Identifier: MPL-2.0

name: Text-to-Speech (Useless Facts)
description: Fetches a random fact and reads it out loud using Kokoro
mode: oneshot
steps:
  # HTTP input (body can be empty, just triggers the pipeline)
  - kind: streamkit::http_input

  # Fetch random fact from API and extract text
  - kind: core::script
    params:
      timeout_ms: 5000
      script: |
        function process(packet) {
          try {
            // Note: fetch() is only allowed if the server is configured with
            // [[script.global_fetch_allowlist]] for https://uselessfacts.jsph.pl/*
            const responseText = fetch('https://uselessfacts.jsph.pl/api/v2/facts/random?language=en');
            const data = JSON.parse(responseText);
            const fact = data && data.text ? String(data.text).trim() : '';
            if (!fact) {
              return { type: 'Text', data: 'Sorry, I could not fetch a fact right now.' };
            }
            return { type: 'Text', data: fact };
          } catch (e) {
            return {
              type: 'Text',
              data: 'Sorry, I could not fetch a fact right now.'
            };
          }
        }

  # Split into sentences for better TTS pacing
  - kind: core::text_chunker
    params:
      split_mode: sentences
      min_length: 10

  # Convert text to speech using Kokoro
  - kind: plugin::native::kokoro
    params:
      model_dir: "models/kokoro-multi-lang-v1_1"
      speaker_id: 0   # af_sarah (female voice)
      speed: 1.0
      num_threads: 4

  # Resample to 48kHz for Opus
  - kind: audio::resampler
    params:
      chunk_frames: 960
      output_frame_size: 960
      target_sample_rate: 48000

  # Encode to Opus
  - kind: audio::opus::encoder
    params:
      bitrate: 64000

  # Wrap in WebM container
  - kind: containers::webm::muxer
    params:
      channels: 1
      chunk_size: 65536
      sample_rate: 48000
      streaming_mode: live

  # HTTP output (returns audio/webm)
  - kind: streamkit::http_output
